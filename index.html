<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket</title>
    
</head>
<body>
    <header>
        <h1></h1>
        <span id="status">Отключен</span>
    </header>

    <main>
        <div id="messages"></div>

        <input id="input" type="text">

            <div class="l-wrap"><div class="three-col-grid">
                <div id="task_1" class="tasks available">Билет 1</div>
                <div id="task_2" class="tasks available">Билет 2</div>
                <div id="task_3" class="tasks available">Билет 3</div>
                <div id="task_4" class="tasks available">Билет 4</div>
                <div id="task_5" class="tasks available">Билет 5</div>
                <div id="task_6" class="tasks available">Билет 6</div>
                <div id="task_7" class="tasks available">Билет 7</div>
                <div id="task_8" class="tasks choosen">Билет 8</div>
                <div id="task_9" class="tasks available">Билет 9</div>
                <div id="task_10" class="tasks available">Билет 10</div>
                <div id="task_11" class="tasks available">Билет 11</div>
                <div id="task_12" class="tasks available">Билет 12</div>
                <div id="task_13" class="tasks available">Билет 13</div>
                <div id="task_14" class="tasks available">Билет 14</div>
                <div id="task_15" class="tasks available">Билет 15</div>
                <div id="task_16" class="tasks available">Билет 16</div>
                <div id="task_17" class="tasks available">Билет 17</div></div>
            </div>
        
    </main>
    <link rel="stylesheet" type="text/css" href="/styles.css" >
    <script >
        const status = document.getElementById('status');
const messages = document.getElementById('messages');
const input = document.getElementById('input');


var HOST = location.origin.replace(/^http/, 'ws')
const ws = new WebSocket(HOST);

for(let i=0, tasks = document.getElementsByClassName('tasks'), len = tasks.length; i < len; i++){
    tasks[i].addEventListener('click', choose);
}
function choose(){
    ws.send(JSON.stringify({username: 'goshanoob', choosenTask: this.id}));
    
    for(let i=0, tasks = document.getElementsByClassName('tasks'), len = tasks.length; i < len; i++){
        tasks[i].removeEventListener('click', choose);
    }
}

function setStatus(value){
    status.innerHTML = value;
}

function printMessage(value){
    for(let i=0; i<value.choosen.length; i++){
        document.getElementById(value.choosen[i]).className = 'tasks choosen';
    }
    
    if(value.hasOwnProperty("username")){
        const div = document.createElement('div');
        div.innerHTML = `Пользователь ${value.username} дропнул билет № ${value.choosenTask.replace(/\D/g,"")}. Удачи`;
        messages.appendChild(div);
    }
    
}


/*
document.getElementById("input").addEventListener('keydown', event =>{
    if(event.keyCode === 13){
        ws.send(JSON.stringify({username: 'goshan_loh',message: input.value}));
        input.value = "";
    }
});*/


ws.onopen = () => setStatus('Подключился');
ws.onclose =() => setStatus('Отключился');
ws.onmessage = response => printMessage(JSON.parse(response.data));

    </script>
</body>
</html>